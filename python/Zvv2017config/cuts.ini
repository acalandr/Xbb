[Cuts]

Hbtag = H
Vtype = Vtype
eIdx  = vLidx
muIdx = vLidx



#additionalPlottingCut = (LHE_Nb==0&&nGenStatus2bHad>0) 
#additionalPlottingCut = (LHE_Nb>0&&LHE_Vpt>100&&LHE_HT<1200)

# MVA training 
# --------------------------------------------------------------------------------------------------
TrainCut = !((event%%2)==0||isData)
EvalCut = ((event%%2)==0||isData)

# --------------------------------------------------------------------------------------------------
# jet & dijet
# --------------------------------------------------------------------------------------------------
jet_pt      = Jet_PtReg
jet_pt0     = Jet_PtReg[<!General|btagidx0!>]
jet_pt1     = Jet_PtReg[<!General|btagidx1!>]

dijet_pt    = H_pt
dijet_phi   = H_phi
dijet_mass  = H_mass



# --------------------------------------------------------------------------------------------------
# V boson
# --------------------------------------------------------------------------------------------------
Vpt         = V_pt
Vphi        = V_phi
Vtype       = Vtype

# --------------------------------------------------------------------------------------------------
# Lepton
# --------------------------------------------------------------------------------------------------
#E_iso     = (Sum$(Electron_pt>20&&Electron_mvaSpring16GP_WP90&&(abs(Electron_eta)>=1.57||abs(Electron_eta)<=1.44)&&Electron_pfRelIso03_all<0.06)>=1) 
#Mu_iso    = (Sum$(Muon_pfRelIso04_all<0.06)>=1) 
E_iso     = 1 
Mu_iso    = 1 
NaddLep     = nAddLeptons 
Muon        = (<!Cuts|Vtype!> == 2 && <!Cuts|Mu_iso!>)
Electron    = (<!Cuts|Vtype!> == 3 && <!Cuts|E_iso!>)
E_OR_dMu    = (<!Cuts|Muon!>||<!Cuts|Electron!>)
# don't use for 2017
#nVetoLeptons = Sum$(Electron_pt>6.5&&abs(Electron_eta)<2.5&&Electron_pfRelIso03_all<0.4&&abs(Electron_dz)<0.2&&abs(Electron_dxy)<0.05&&Electron_lostHits<1.0)+Sum$(Muon_pt>4.5&&abs(Muon_eta)<2.4&&Muon_pfRelIso04_all<0.4&&abs(Muon_dz)<0.2&&abs(Muon_dxy)<0.05)
nVetoLeptons = (nVetoElectrons+nVetoMuons) 
nAddLeptons  = nAddLeptons

# --------------------------------------------------------------------------------------------------
# MET
# --------------------------------------------------------------------------------------------------
METphi      = MET_Phi
METpt       = MET_Pt
tkMETphi    = TkMET_phi

# --------------------------------------------------------------------------------------------------
# Additional jets
# --------------------------------------------------------------------------------------------------

# take composite variables from ntuples (fast) or recompute (slow)
#CutType = DEFAULT
CutType = RECOMPUTE

# default cut set from precomputed branches
DphiV_H_DEFAULT             = abs(TVector2::Phi_mpi_pi(<!Cuts|dijet_phi!>-<!Cuts|METphi!>)) 
MinDphiMET_Jet_DEFAULT      = minDphiJetMet 
QCD_DEFAULT                 = (nAddJetQCD>0)
AntiQCD_DEFAULT             = (nAddJetQCD==0)
DphiMET_tkMET_DEFAULT       = dPhiMetTkMet 
NaddJets_DEFAULT            = nAddJet30 
# recompute variables
DphiV_H_RECOMPUTE           = abs(TVector2::Phi_mpi_pi(<!Cuts|dijet_phi!>-<!Cuts|METphi!>))
MinDphiMET_Jet_RECOMPUTE    = Min$(abs(TVector2::Phi_mpi_pi(Jet_phi[hJidx]-<!Cuts|METphi!>)))
QCD_RECOMPUTE               = Sum$(abs(TVector2::Phi_mpi_pi(Jet_phi-<!Cuts|Vphi!>))<0.5&&Jet_Pt>30&&(Jet_puId>6||Jet_Pt>50)&&Jet_lepFilter)>0
AntiQCD_RECOMPUTE           = Sum$(abs(TVector2::Phi_mpi_pi(Jet_phi-<!Cuts|Vphi!>))<0.5&&Jet_Pt>30&&(Jet_puId>6||Jet_Pt>50)&&Jet_lepFilter)==0
DphiMET_tkMET_RECOMPUTE     = abs(TVector2::Phi_mpi_pi(<!Cuts|METphi!>-<!Cuts|tkMETphi!>))
NaddJets_RECOMPUTE          = Sum$(Jet_Pt>30&&abs(Jet_eta)<2.4&&(Jet_puId>6||Jet_Pt>50)&&Jet_lepFilter&&Iteration$!=<!General|btagidx0!>&&Iteration$!=<!General|btagidx1!>) 

# select
DphiV_H                     = <!Cuts|DphiV_H_<!Cuts|CutType!>!>
MinDphiMET_Jet              = <!Cuts|MinDphiMET_Jet_<!Cuts|CutType!>!> 
DphiMET_tkMET               = <!Cuts|DphiMET_tkMET_<!Cuts|CutType!>!>
QCD                         = <!Cuts|QCD_<!Cuts|CutType!>!>
AntiQCD                     = <!Cuts|AntiQCD_<!Cuts|CutType!>!>
NaddJets                    = <!Cuts|NaddJets_<!Cuts|CutType!>!>

resolvedJets = (hJidx[0]>-1&&hJidx[1]>-1)
# --------------------------------------------------------------------------------------------------
# BASIC cuts:  Selection common to all CR
# --------------------------------------------------------------------------------------------------
BasicCuts   = (min(MHT_pt, MET_Pt) > 100 && <!General|btag1!> > <!General|btagWP_Loose!> && H_mass < 500 && H_pt > 120.0 && <!Cuts|resolvedJets!>)

Incl = isZnn

# --------------------------------------------------------------------------------------------------
# CONTROL regions
# --------------------------------------------------------------------------------------------------

# AT uses somehow MET filters for the TT control region even though its SingleLepton dataset
# MetFilters = (Flag_goodVertices && Flag_globalTightHalo2016Filter && Flag_HBHENoiseFilter && Flag_HBHENoiseIsoFilter && Flag_EcalDeadCellTriggerPrimitiveFilter && Flag_BadPFMuonFilter && Flag_BadChargedCandidateFilter && Flag_ecalBadCalibFilter && (!isData || Flag_eeBadScFilter))
MetFilters = 1


; TT
ttbar_base         = (<!Cuts|MetFilters!> && <!Cuts|BasicCuts!> && <!General|btag0!> > <!General|btagWP_Medium!> && <!Cuts|METpt!> > 170.0 && abs(TVector2::Phi_mpi_pi(H_phi-V_phi)) > 2.0 && Min$(abs(TVector2::Phi_mpi_pi(Jet_phi[hJidx]-MET_Phi))) < 1.57 && <!Cuts|NaddJets!> >= 2) 
ttbar_SingleLepton = (<!.|ttbar_base!> && (isWmunu || isWenu)) 
ttbar_MET          = (<!.|ttbar_base!> && isZnn && <!Cuts|AntiQCD!>)
ttbar              = <!.|ttbar_<!General|TTdataset!>!>

; Z+LF
Zlf             = <!Cuts|BasicCuts!> && isZnn && <!Cuts|DphiV_H!> > 2.0 && <!General|btag0!> < <!General|btagWP_Medium!> && <!Cuts|AntiQCD!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!><2

; Z+HF
Zhf             = <!Cuts|BasicCuts!> && isZnn && <!Cuts|DphiV_H!> > 2.0 && <!Cuts|AntiQCD!> && (<!Cuts|dijet_mass!> < 90 || <!Cuts|dijet_mass!> > 150) && <!General|btag0!> > <!General|btagWP_Tight!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!><2

VV_Zhf          = <!Cuts|BasicCuts!> && isZnn && <!Cuts|DphiV_H!> > 2.0 && <!Cuts|AntiQCD!> && (<!Cuts|dijet_mass!> < 60 || <!Cuts|dijet_mass!> > 120) && <!General|btag0!> > <!General|btagWP_Tight!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!><2

# --------------------------------------------------------------------------------------------------
# SIGNAL region
# --------------------------------------------------------------------------------------------------
SR     = isZnn && H_pt > 120 && <!Cuts|DphiV_H!> > 2.0 && min(MHT_pt, MET_Pt) > 100 && <!Cuts|AntiQCD!> && (<!Cuts|dijet_mass!> > 90 && <!Cuts|dijet_mass!> < 150) && <!General|btag0!> > <!General|btagWP_Medium!> && <!General|btag1!> > <!General|btagWP_Loose!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!> < 2 && <!Cuts|nAddLeptons!>==0

VV_SR  = isZnn && H_pt > 120 && <!Cuts|DphiV_H!> > 2.0 && min(MHT_pt, MET_Pt) > 100 && <!Cuts|AntiQCD!> && (<!Cuts|dijet_mass!> > 60 && <!Cuts|dijet_mass!> < 120) && <!General|btag0!> > <!General|btagWP_Medium!> && <!General|btag1!> > <!General|btagWP_Loose!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!> < 2 && <!Cuts|nAddLeptons!>==0

med     = (<!Cuts|METpt!> >= 150.0 && <!Cuts|METpt!> < 250.0)
medhigh = (<!Cuts|METpt!> >= 150.0)
high    = (<!Cuts|METpt!> >= 250.0)

ttbar_med_Znn     = (<!Cuts|ttbar!>)&&(<!Cuts|med!>) 
Zlf_med_Znn       = (<!Cuts|Zlf!>)&&(<!Cuts|med!>)
Zhf_med_Znn       = (<!Cuts|Zhf!>)&&(<!Cuts|med!>)
SR_med_Znn        = (<!Cuts|SR!>)&&(<!Cuts|med!>)

ttbar_med_Znn_0j   = (<!Cuts|ttbar!>)&&<!Cuts|med!>&&<!Cuts|0j!> 
Zlf_med_Znn_0j     = (<!Cuts|Zlf!>)&&<!Cuts|med!>&&<!Cuts|0j!>
Zhf_med_Znn_0j     = (<!Cuts|Zhf!>)&&<!Cuts|med!>&&<!Cuts|0j!>
SR_med_Znn_0j      = (<!Cuts|SR!>)&&<!Cuts|med!>&&<!Cuts|0j!>

ttbar_med_Znn_ge1j = (<!Cuts|ttbar!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>
Zlf_med_Znn_ge1j   = (<!Cuts|Zlf!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>
Zhf_med_Znn_ge1j   = (<!Cuts|Zhf!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>
SR_med_Znn_ge1j    = (<!Cuts|SR!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>

ttbar_high_Znn    = (<!Cuts|ttbar!>)&&(<!Cuts|high!>) 
Zlf_high_Znn      = (<!Cuts|Zlf!>)&&(<!Cuts|high!>)
Zhf_high_Znn      = (<!Cuts|Zhf!>)&&(<!Cuts|high!>)
SR_high_Znn       = (<!Cuts|SR!>)&&(<!Cuts|high!>)

ttbar_medhigh_Znn = (<!Cuts|ttbar!>)&&(<!Cuts|medhigh!>) 
Zlf_medhigh_Znn   = (<!Cuts|Zlf!>)&&(<!Cuts|medhigh!>)
Zhf_medhigh_Znn   = (<!Cuts|Zhf!>)&&(<!Cuts|medhigh!>)
SR_medhigh_Znn    = (<!Cuts|SR!>)&&(<!Cuts|medhigh!>)

# VV

VV_SR_med_Znn      = (<!Cuts|VV_SR!>)&&<!Cuts|med!>
VV_SR_med_Znn_0j   = (<!Cuts|VV_SR!>)&&<!Cuts|med!>&&<!Cuts|0j!>
VV_SR_med_Znn_ge1j = (<!Cuts|VV_SR!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>
VV_SR_high_Znn     = (<!Cuts|VV_SR!>)&&<!Cuts|high!>
VV_SR_medhigh_Znn  = (<!Cuts|VV_SR!>)&&<!Cuts|medhigh!>

VV_Zhf_med_Znn      = (<!Cuts|VV_Zhf!>)&&<!Cuts|med!>
VV_Zhf_med_Znn_0j   = (<!Cuts|VV_Zhf!>)&&<!Cuts|med!>&&<!Cuts|0j!>
VV_Zhf_med_Znn_ge1j = (<!Cuts|VV_Zhf!>)&&<!Cuts|med!>&&<!Cuts|ge1j!>
VV_Zhf_high_Znn     = (<!Cuts|VV_Zhf!>)&&<!Cuts|high!>
VV_Zhf_medhigh_Znn  = (<!Cuts|VV_Zhf!>)&&<!Cuts|medhigh!>

# --------------------------------------------------------------------------------------------------
# Mjj regions
# --------------------------------------------------------------------------------------------------
# cuts based on 25%, 50%, 75% quantiles of signal
# 0.0624 0.4467 0.9254
# V11_v1: 0.4669 0.6103 0.7379
# V11_VVVH: 0.4121 0.5442 0.6815
Mjj_cut_01 = 0.4121 
Mjj_cut_12 = 0.5442
Mjj_cut_23 = 0.6815

Mjj_0 = (<!Cuts|Sig!>) && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal < <!Cuts|Mjj_cut_01!>
Mjj_1 = (<!Cuts|Sig!>) && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal >= <!Cuts|Mjj_cut_01!> && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal < <!Cuts|Mjj_cut_12!>
Mjj_2 = (<!Cuts|Sig!>) && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal >= <!Cuts|Mjj_cut_12!> && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal < <!Cuts|Mjj_cut_23!>
Mjj_3 = (<!Cuts|Sig!>) && <!Mjj_SR_medhigh_Znn|branchName!>.Nominal >= <!Cuts|Mjj_cut_23!>

# --------------------------------------------------------------------------------------------------
# Multi classifier regions 
# --------------------------------------------------------------------------------------------------
Inclusive        = (1)
Multi     = isZnn && <!Cuts|NaddLep!> == 0 && <!Cuts|AntiQCD!> && <!General|btag0!> > <!General|btagWP_Loose!> && <!Cuts|DphiMET_tkMET!> < 0.5 && <!Cuts|NaddJets!> < 3 && min(MHT_pt, MET_Pt) > 100 && H_pt > 120.0 && <!Cuts|METpt!> > 170.0 && abs(TVector2::Phi_mpi_pi(H_phi-MET_Phi))>2.0 && Min$(abs(TVector2::Phi_mpi_pi(Jet_phi[hJidx]-MET_Phi))) > 0.5

Multi_medhigh_Znn = <!Cuts|Multi!> 

;Multi-output classifier regions
Multi_medhigh_Znn_Zbb      = <!Cuts|Multi!>   
Multi_medhigh_Znn_Zb       = <!Cuts|Multi!>
Multi_medhigh_Znn_Zlight   = <!Cuts|Multi!>
Multi_medhigh_Znn_Wbb      = <!Cuts|Multi!>
Multi_medhigh_Znn_Wb       = <!Cuts|Multi!>
Multi_medhigh_Znn_Wlight   = <!Cuts|Multi!>
Multi_medhigh_Znn_ST       = <!Cuts|Multi!>
Multi_medhigh_Znn_TT       = <!Cuts|Multi!>
Multi_medhigh_Znn_VV       = <!Cuts|Multi!>
Multi_medhigh_Znn_VVLF     = <!Cuts|Multi!>
Multi_medhigh_Znn_VVHF     = <!Cuts|Multi!>
Multi_medhigh_Znn_VH       = <!Cuts|Multi!>


HighPt_Inclusive  = <!Cuts|Inclusive!>







#----- BOOST selection -----#
#----- Boosted: Signal region and control region -----#


dijet_mass  =H_mass
dijet_mass_BOOST= FatJet_msoftdrop[Hbb_fjidx]
ElectronSel = Alt$(<!Cuts|Electron!> && (abs(Electron_eta[<!Cuts|eIdx!>[0]])>=1.57||abs(Electron_eta[<!Cuts|eIdx!>[0]])<=1.44) && Electron_pt[<!Cuts|eIdx!>[0]] > 30 && <!Cuts|E_iso!>[<!Cuts|eIdx!>[0]] < 0.06 && Electron_mvaSpring16GP_WP80[<!Cuts|eIdx!>[0]],0)
MuonSel     = Alt$((<!Cuts|Muon!> && <!Cuts|Mu_iso!>[<!Cuts|muIdx!>[0]] < 0.06 && Muon_pt[<!Cuts|muIdx!>[0]] > 25),0)
EandMuSelection = (<!Cuts|ElectronSel!>||<!Cuts|MuonSel!>)

DphiMET_Lep = lepMetDPhi
NaddLep=nAddLeptons
BasicCuts_BOOST= (FatJet_pt[Hbb_fjidx]>250 && abs(FatJet_eta[Hbb_fjidx])<2.5 && V_pt > 250 && Hbb_fjidx>-1 &&  <!Cuts|dijet_mass_BOOST!> >50)


#Region definitions
Signal_BOOSTv3                  = (<!Cuts|BasicCuts_BOOST!>  && <!Cuts|dijet_mass_BOOST!> > 90 && <!Cuts|dijet_mass_BOOST!> < 150 && FatJet_deepTagMD_bbvsLight[Hbb_fjidx]>0.8 && Sum$(VHbb::deltaR(FatJet_eta[Hbb_fjidx],FatJet_phi[Hbb_fjidx],Jet_eta,Jet_phi)> 0.8 && Jet_btagDeepCSV > <!General|btagWP_Medium_DeepCSV!> && Jet_lepFilter>0) == 0 && NaddLep==0)

tt_BOOST                        = (<!Cuts|BasicCuts_BOOST!>  && <!Cuts|dijet_mass_BOOST!> > 50 && FatJet_deepTagMD_bbvsLight[Hbb_fjidx]>0.8 && Sum$(VHbb::deltaR(FatJet_eta[Hbb_fjidx],FatJet_phi[Hbb_fjidx],Jet_eta,Jet_phi)> 0.8 && Jet_btagDeepCSV > <!General|btagWP_Medium_DeepCSV!> && Jet_lepFilter>0) > 0 && NaddLep>0)

Zlf_BOOSTv11                    = (<!Cuts|BasicCuts_BOOST!>  && <!Cuts|dijet_mass_BOOST!> > 50 &&  FatJet_deepTagMD_bbvsLight[Hbb_fjidx]>-0.8 &&  FatJet_deepTagMD_bbvsLight[Hbb_fjidx]<0.8 && Sum$(VHbb::deltaR(FatJet_eta[Hbb_fjidx],FatJet_phi[Hbb_fjidx],Jet_eta,Jet_phi)> 0.8 && Jet_btagDeepCSV > <!General|btagWP_Medium_DeepCSV!> && Jet_lepFilter>0) == 0 && NaddLep==0)

Zhf_BOOSTv2                     = (<!Cuts|BasicCuts_BOOST!> && (<!Cuts|dijet_mass_BOOST!> > 50 && <!Cuts|dijet_mass_BOOST!> < 90 || <!Cuts|dijet_mass_BOOST!>150) && FatJet_deepTagMD_bbvsLight[Hbb_fjidx]>0.8 && Sum$(VHbb::deltaR(FatJet_eta[Hbb_fjidx],FatJet_phi[Hbb_fjidx],Jet_eta,Jet_phi)> 0.8 && Jet_btagDeepCSV > <!General|btagWP_Medium_DeepCSV!> && Jet_lepFilter>0)== 0 && NaddLep==0)


SR_high_Znn_BOOST 			= <!Cuts|Signal_BOOSTv3!> && <!Cuts|ElectronSel!>
ttbar_high_Znn_BOOST			= <!Cuts|tt_BOOST!> && <!Cuts|ElectronSel!>
Zlf_high_Znn_BOOST			= <!Cuts|Zlf_BOOSTv11!> && <!Cuts|ElectronSel!>
Zhf_high_Znn_BOOST			= <!Cuts|Zhf_BOOSTv2!> && <!Cuts|ElectronSel!>
